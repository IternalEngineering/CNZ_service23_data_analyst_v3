# City Insights Microservice - Setup Guide

Complete guide to deploy the City Insights Microservice for real-time access to cached city insights from service23.

## Overview

This microservice provides instant access to cached city insights generated by the service23 data analyst agent. It follows the same pattern as the Gap Analyzer Microservice but is tailored for the `service23_data_analyst_insights` table.

## Prerequisites

- Python 3.11+
- PostgreSQL database access (urbanzero-db)
- Environment variables configured
- pip or uv package manager

## Quick Start

```bash
# 1. Navigate to service23 directory
cd server_c/service23

# 2. Install dependencies (if not already installed)
pip install fastapi uvicorn pydantic psycopg2-binary python-dotenv

# 3. Run the microservice
python insights_microservice.py

# 4. Test the endpoint
curl http://localhost:8024/
```

## Configuration

### Port Configuration

The service runs on **port 8024** by default. This can be configured via environment variable:

```bash
PORT=8024  # Default port for insights microservice
```

### Environment Variables

Create or update `.env` file in the parent directory (`server_c/.env`):

```bash
# Database Configuration (Required)
DB_HOST=urbanzero-db.c5qeo4ayy5u5.eu-west-2.rds.amazonaws.com
DB_PORT=5432
DB_NAME=urbanzero-db
DB_USER=urbanzero_app
DB_PASSWORD=UrbanZero2024$Secure

# Service Configuration (Optional)
PORT=8024
HOST=0.0.0.0
```

## Database Schema

The microservice reads from the `service23_data_analyst_insights` table:

```sql
service23_data_analyst_insights (
    id UUID PRIMARY KEY,
    city VARCHAR(255) NOT NULL,
    country_code VARCHAR(2) NOT NULL,
    success_criteria TEXT,
    insight_summary TEXT NOT NULL,
    detailed_analysis TEXT NOT NULL,
    data_sources_used JSONB DEFAULT '[]',
    confidence_score DECIMAL(3,2),
    recommendations JSONB DEFAULT '[]',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    alert_sent BOOLEAN DEFAULT FALSE,
    alert_id VARCHAR(255)
)
```

## API Endpoints

### 1. Health Check

```bash
GET /
GET /health
```

**Response:**
```json
{
  "service": "City Insights Microservice",
  "status": "running",
  "version": "1.0.0",
  "port": 8024,
  "docs": "/docs",
  "table": "service23_data_analyst_insights"
}
```

### 2. Query City Insight (Council Officials)

```bash
POST /chat/city
Content-Type: application/json

{
  "query": "Show me the insights for Bristol"
}
```

**Response:**
```json
{
  "reply": "Bristol city insights show significant opportunities in renewable energy transition",
  "replySummary": "Analysis for Bristol generated on 2025-10-28 10:30 (Confidence: 85%). The city has strong foundation in sustainability initiatives with multiple renewable energy projects identified. Generated 5 actionable recommendations.",
  "table": "service23_data_analyst_insights",
  "id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Use Case:** Council officials checking their city's specific insights

**Supported Query Formats:**
- "Show me the insights for Bristol"
- "What insights do we have for Manchester?"
- "Tell me about Edinburgh's data analysis"

### 3. Query Cities by Country (Investors)

```bash
POST /chat/cities
Content-Type: application/json

{
  "query": "Show me cities in the UK"
}
```

**Response:**
```json
{
  "reply": "London city insights show advanced net-zero readiness",
  "replySummary": "Analysis for London generated on 2025-10-28 12:15 (Confidence: 92%). Comprehensive analysis of London's sustainability landscape reveals strong alignment with net-zero goals... Generated 8 actionable recommendations.",
  "table": "service23_data_analyst_insights",
  "id": "660e8400-e29b-41d4-a716-446655440001"
}
```

**Use Case:** Investors exploring opportunities across multiple cities

**Supported Query Formats:**
- "Show me cities in the UK"
- "What cities are available in Great Britain?"
- "List all UK city insights"

### 4. Get Recent Insights

```bash
GET /insights/recent?limit=10
```

**Response:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "city": "Bristol",
    "country_code": "GB",
    "insight_summary": "Bristol shows strong renewable energy potential",
    "confidence_score": 0.85,
    "created_at": "2025-10-28T10:30:00"
  },
  ...
]
```

**Use Case:** Dashboard overview of recent insights

### 5. Get Insight by ID

```bash
GET /insights/{insight_id}
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "city": "Bristol",
  "country_code": "GB",
  "success_criteria": "Achieve net zero by 2030",
  "insight_summary": "Bristol shows strong renewable energy potential",
  "detailed_analysis": "Comprehensive analysis reveals...",
  "data_sources_used": ["opportunities", "data_sources", "reports"],
  "confidence_score": 0.85,
  "recommendations": [
    {
      "priority": "high",
      "action": "Implement solar panel program",
      "expected_impact": "20% emissions reduction"
    }
  ],
  "created_at": "2025-10-28T10:30:00",
  "updated_at": "2025-10-28T10:30:00",
  "alert_sent": true,
  "alert_id": "alert_123"
}
```

**Use Case:** Detailed view of a specific insight

### 6. Get All Insights for a City

```bash
GET /insights/city/{city_name}?country_code=GB&limit=10
```

**Response:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "city": "Bristol",
    "country_code": "GB",
    "insight_summary": "Recent analysis shows progress",
    "confidence_score": 0.85,
    "created_at": "2025-10-28T10:30:00"
  },
  ...
]
```

**Use Case:** Historical tracking of city insights over time

## Running the Service

### Development Mode (with auto-reload)

```bash
python insights_microservice.py
```

The service will start on http://localhost:8024

### Production Mode (with Uvicorn)

```bash
uvicorn insights_microservice:app --host 0.0.0.0 --port 8024 --workers 4
```

### Using PM2 (Recommended for Production)

```bash
# Install PM2
npm install -g pm2

# Start service
pm2 start insights_microservice.py --interpreter python --name service23-insights-api

# Save configuration
pm2 save

# Setup auto-restart on boot
pm2 startup

# View logs
pm2 logs service23-insights-api
```

### Using systemd (Linux)

Create `/etc/systemd/system/service23-insights.service`:

```ini
[Unit]
Description=Service23 City Insights Microservice
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/urbanzero/server_c/service23
Environment="PATH=/opt/urbanzero/venv/bin"
ExecStart=/opt/urbanzero/venv/bin/python insights_microservice.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable service23-insights
sudo systemctl start service23-insights
sudo systemctl status service23-insights
```

## Testing

### Test Health Endpoint

```bash
curl http://localhost:8024/health
```

Expected response with database connection count:
```json
{
  "status": "healthy",
  "service": "city_insights_microservice",
  "database": "connected",
  "insights_count": 15,
  "timestamp": "2025-10-28T12:30:00"
}
```

### Test City Query

```bash
curl -X POST http://localhost:8024/chat/city \
  -H "Content-Type: application/json" \
  -d '{"query": "Show me Bristol insights"}'
```

### Test Country Query

```bash
curl -X POST http://localhost:8024/chat/cities \
  -H "Content-Type: application/json" \
  -d '{"query": "Show me UK cities"}'
```

### Interactive API Documentation

Once running, access the interactive Swagger UI:

- **Swagger UI**: http://localhost:8024/docs
- **ReDoc**: http://localhost:8024/redoc

## Natural Language Query Support

The microservice includes basic natural language parsing that recognizes:

### Supported Cities
- Bristol, Manchester, Birmingham, Leeds, Edinburgh
- London, Glasgow, Liverpool, Newcastle, Sheffield
- Boston, Dubai, Singapore, Tokyo, Nottingham

### Supported Countries
- UK/Britain/England/Scotland/Wales → GB
- USA/America/United States → US
- UAE/Dubai/Emirates → AE
- Singapore → SG
- Japan → JP

### Example Queries
- "Show me the insights for Bristol"
- "What about Manchester in the UK?"
- "Tell me about London's analysis"
- "Show me cities in Great Britain"
- "List UK cities"

## Integration with Service23

This microservice complements the main service23 API server:

- **Main API (port 8023)**: Triggers new insight generation
- **Insights Microservice (port 8024)**: Returns cached results instantly

### Workflow

1. **Generate New Insight** (service23 API)
   ```bash
   POST http://localhost:8023/api/analyze/city-insights
   {
     "city": "Bristol",
     "country_code": "GB"
   }
   ```
   Takes 2-5 minutes to analyze and generate insight

2. **Query Cached Insight** (insights microservice)
   ```bash
   POST http://localhost:8024/chat/city
   {
     "query": "Show me Bristol insights"
   }
   ```
   Returns instantly from database cache

## Architecture Benefits

### Why a Separate Microservice?

1. **Performance**: Instant response from cached data vs 2-5 minute generation time
2. **Scalability**: Read queries don't impact AI agent processing
3. **Availability**: Cached insights available even during agent processing
4. **Simplicity**: Focused API surface for read-only operations
5. **Cost Optimization**: No AI API calls for repeated queries

### Comparison

| Feature | Main API (8023) | Insights Microservice (8024) |
|---------|----------------|------------------------------|
| Purpose | Generate insights | Query cached insights |
| Response Time | 2-5 minutes | <100ms |
| AI Processing | Yes | No |
| API Calls | OpenAI, Anthropic | None |
| Use Case | New analysis | Quick lookups |
| Endpoint | `/api/analyze/city-insights` | `/chat/city`, `/chat/cities` |

## Troubleshooting

### Port Already in Use

```bash
# Windows
netstat -ano | findstr :8024

# Linux/Mac
lsof -i :8024

# Change port in .env
PORT=8025
```

### Database Connection Failed

1. Verify `.env` credentials are correct
2. Check network access to RDS (VPN/firewall)
3. Ensure SSL mode is set to `require`
4. Test connection:
   ```bash
   curl http://localhost:8024/health
   ```

### No Insights Found

1. Verify table exists:
   ```sql
   SELECT COUNT(*) FROM service23_data_analyst_insights;
   ```

2. Check table has data:
   ```sql
   SELECT city, country_code, created_at
   FROM service23_data_analyst_insights
   ORDER BY created_at DESC
   LIMIT 5;
   ```

3. Generate insights using main API:
   ```bash
   curl -X POST http://localhost:8023/api/analyze/city-insights \
     -H "Content-Type: application/json" \
     -d '{"city": "Bristol", "country_code": "GB"}'
   ```

### ImportError: No module named 'fastapi'

```bash
pip install -r requirements.txt

# Or install manually
pip install fastapi uvicorn pydantic psycopg2-binary python-dotenv
```

## Dependencies

Required packages (minimal):

```txt
fastapi==0.109.0
uvicorn==0.27.0
pydantic==2.6.0
psycopg2-binary==2.9.9
python-dotenv==1.0.0
```

## Security Considerations

1. **Database Credentials**: Use environment variables, never hardcode
2. **API Keys**: Not required for read-only operations
3. **CORS**: Restrict allowed origins in production:
   ```python
   allow_origins=["https://urbanzero.app"]
   ```
4. **Rate Limiting**: Consider adding rate limiting middleware
5. **Authentication**: Add API key authentication for production:
   ```python
   from fastapi.security import APIKeyHeader
   ```

## Monitoring

### Health Checks

Set up automated monitoring:

```bash
# Cron job (every 5 minutes)
*/5 * * * * curl -f http://localhost:8024/health || echo "Service down" | mail -s "Alert" admin@example.com
```

### Logging

Service logs to stdout. In production:

```bash
# Redirect to file
python insights_microservice.py > logs/insights-microservice.log 2>&1

# Or use PM2
pm2 logs service23-insights-api
```

### Metrics

Key metrics to monitor:
- Response time for `/chat/city` endpoint
- Database connection pool utilization
- Cache hit/miss ratio (insights found vs not found)
- Query patterns and popular cities

## Deployment Checklist

- [ ] Environment variables configured
- [ ] Database connection tested
- [ ] Table `service23_data_analyst_insights` exists and has data
- [ ] Port 8024 available (or alternative configured)
- [ ] CORS origins configured for production
- [ ] Health check endpoint responding
- [ ] API documentation accessible
- [ ] PM2/systemd service configured
- [ ] Logging configured
- [ ] Monitoring/alerts set up

## API Response Format

All chat endpoints return consistent format:

```typescript
interface ChatResponse {
  reply: string;              // One-line summary
  replySummary: string;       // Paragraph summary
  table: string;              // Database table name
  id: string;                 // UUID of the record
}
```

This format matches the gap_analyzer_microservice pattern for consistency across services.

## Future Enhancements

- [ ] Redis caching layer for ultra-fast responses
- [ ] Enhanced NLP for natural language parsing
- [ ] Support for date range queries
- [ ] Aggregated insights across multiple cities
- [ ] Webhook notifications for new insights
- [ ] GraphQL API alongside REST
- [ ] Search functionality across insight text
- [ ] Export insights to PDF/CSV

## Support

For issues:
1. Check logs: `pm2 logs service23-insights-api`
2. Verify database connection: `curl http://localhost:8024/health`
3. Test endpoints: http://localhost:8024/docs
4. Check table has data in PostgreSQL

## Related Services

- **Service23 Main API** (port 8023): Insight generation
- **Service2 Gap Analyzer** (port 8005): Gap analysis microservice
- **Main UrbanZero API**: Full platform functionality

---

**Version**: 1.0.0
**Last Updated**: 2025-10-28
**Service Port**: 8024 (default)
**Database**: urbanzero-db (PostgreSQL)
**Table**: service23_data_analyst_insights
